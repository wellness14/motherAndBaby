var pubApp = angular
    .module("PubApp", ['ngSanitize']).directive('ajaxLoading', ajaxLoading);

pubApp.config(['$provide', '$httpProvider', function($provide, $httpProvider) {
    $httpProvider.interceptors.push('requestErrorHandler');
}]);

pubApp.factory('requestErrorHandler', ['$q', function($q) {
    return {
        responseError: function(rejection) {
            if (rejection.status === 0) {
                alert('네트워크에 연결되지 않았습니다. 네트워크 연결 후 다시 시도해 주세요.');
            } else if (rejection.status == 404) {
                alert('페이지를 찾을 수 없습니다.');
            } else if (rejection.status == 500) {
                alert('서비스가 불안정합니다. 나중에 다시 시도해주세요.');
            } else if (rejection.status == 403) {
                alert('접근권한이 없습니다.');
            } else if (rejection.status == 405) {
                alert('허용된 액션이 아닙니다.');
            } else {
                alert('알수 없는 오류가 발생하였습니다.\n');
            }

            return $q.reject(rejection);
        }
    };
}]);

ajaxLoading.$inject = ['$http'];

function ajaxLoading($http) {
    var ajaxLoadingTemplate = [
        '<div id="ajax-loading-holder" style="height: 100%; width: 100%; z-index: 999999; background: transparent;">',
        '  <div id="ajax-loading" style="position: fixed; z-index: 9999999; top: 50%; left: 50%; display: none; background: transparent url(/web/image/loading.gif); border: none; width: 48px; height: 48px;"></div>',
        '</div>'
    ].join("");

    var directive = {
        restrict: 'E',
        replace: true,
        template: ajaxLoadingTemplate,
        link: link
    };
    return directive;

    function link (scope, element, attr) {
        scope.isLoading = function () {
            return $http.pendingRequests.length > 0;
        };

        scope.$watch(scope.isLoading, function (val) {
            if (val) {
                element.find('#ajax-loading').show();
            } else {
                element.find('#ajax-loading').hide();
            }
        });
    }
}
